{% extends "base.html" %}
{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Dashboard</h2>

  <div class="d-flex gap-2">
    {% if can_export %}
      <a class="btn btn-outline-success" href="{% url 'reports_home' %}">
        Centro de reportes
      </a>
    {% endif %}
  </div>
</div>

<form method="get" class="card shadow-sm mb-3">
  <div class="card-body d-flex flex-wrap gap-2 align-items-end">
    <div>
      <label class="form-label mb-1">Warehouse</label>
      <select class="form-select" name="warehouse_id">
        <option value="">Todos</option>
        {% for wh in warehouses %}
          <option value="{{ wh.id }}" {% if filter_warehouse_id|stringformat:"s" == wh.id|stringformat:"s" %}selected{% endif %}>
            {{ wh.code }}
          </option>
        {% endfor %}
      </select>
    </div>

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">Aplicar</button>
      <a class="btn btn-outline-secondary" href="{% url 'dashboard' %}">Limpiar</a>
    </div>

    {% if filter_warehouse_id %}
      <div class="ms-auto text-muted small">
        Filtrando por warehouse ID: <span class="fw-semibold">{{ filter_warehouse_id }}</span>
      </div>
    {% endif %}
  </div>
</form>


<!-- ===================== -->
<!-- KPIs -->
<!-- ===================== -->
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-danger">
      <div class="card-body">
        <div class="text-muted small">Items bajo mínimo</div>
        <div class="fs-3 fw-semibold">{{ kpi_low_count }}</div>
        <div class="text-muted small">Por ubicación</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-primary">
      <div class="card-body">
        <div class="text-muted small">Movimientos hoy</div>
        <div class="fs-3 fw-semibold">{{ kpi_movements_today }}</div>
        <div class="text-muted small">Sin contar anulados</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-success">
      <div class="card-body">
        <div class="text-muted small">Stock total (On Hand)</div>
        <div class="fs-3 fw-semibold">{{ kpi_total_on_hand }}</div>
        <div class="text-muted small">Suma de snapshots</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-warning">
      <div class="card-body">
        <div class="text-muted small">Reservado total</div>
        <div class="fs-3 fw-semibold">{{ kpi_total_reserved }}</div>
        <div class="text-muted small">Comprometido (reserved)</div>
      </div>
    </div>
  </div>
</div>

<div class="row g-3 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm border-info">
      <div class="card-body">
        <div class="text-muted small">Disponible total</div>
        <div class="fs-3 fw-semibold">{{ kpi_total_available }}</div>
        <div class="text-muted small">On Hand - Reserved</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm border-secondary">
      <div class="card-body">
        <div class="text-muted small">Consumo (OUT) 7 días</div>
        <div class="fs-3 fw-semibold">{{ kpi_out_7d }}</div>
        <div class="text-muted small">Sin anulados</div>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm border-danger">
      <div class="card-body">
        <div class="text-muted small">Riesgo de quiebre</div>
        <div class="fs-3 fw-semibold">{{ kpi_stockout_risk }}</div>
        <div class="text-muted small">Bajo mínimo + reservado</div>
      </div>
    </div>
  </div>
</div>

{% if has_wo %}
<div class="row g-3 mb-4">
  <div class="col-md-3">
    <div class="card shadow-sm border-dark">
      <div class="card-body">
        <div class="text-muted small">Work Orders abiertas</div>
        <div class="fs-3 fw-semibold">{{ kpi_wo_open }}</div>
        <div class="text-muted small">No completadas/canceladas</div>
      </div>
    </div>
  </div>

  <div class="col-md-3">
    <div class="card shadow-sm border-secondary">
      <div class="card-body">
        <div class="text-muted small">Work Orders pausadas</div>
        <div class="fs-3 fw-semibold">{{ kpi_wo_paused }}</div>
        <div class="text-muted small">En estado PAUSED</div>
      </div>
    </div>
  </div>

  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="text-muted small">Acceso rápido</div>
        <div class="d-flex flex-wrap gap-2 mt-2">
          <a class="btn btn-outline-dark" href="{% url 'workorders:list' %}">Work Orders</a>
          <a class="btn btn-outline-primary" href="{% url 'workorders:create' %}">Crear Work Order</a>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<!-- ===================== -->
<!-- Gráficas -->
<!-- ===================== -->
<div class="row g-3 mb-4">
  <div class="col-md-7">
    <div class="card shadow-sm">
      <div class="card-header">Movimientos por día (últimos 14 días)</div>
      <div class="card-body">
        <canvas id="chartMovementsDaily" height="110"></canvas>
      </div>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card shadow-sm">
      <div class="card-header">Top 10 consumo (OUT) últimos 30 días</div>
      <div class="card-body">
        <canvas id="chartTopOut" height="110"></canvas>
      </div>
    </div>
  </div>
</div>

<div class="card shadow-sm mb-4">
  <div class="card-header">Stock (On Hand) por Warehouse</div>
  <div class="card-body">
    <canvas id="chartStockByWh" height="90"></canvas>
  </div>
</div>

<!-- ===================== -->
<!-- Acciones -->
<!-- ===================== -->
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="card-title mb-2">Acciones</h5>

    <div class="d-flex flex-wrap gap-2">
      <a class="btn btn-primary" href="{% url 'movement_create' %}">
        Registrar entrada / salida
      </a>

      {% if can_transfer %}
        <a class="btn btn-outline-primary" href="{% url 'transfer_create' %}">
          Transferir
        </a>
      {% endif %}

      {% if can_adjust %}
        <a class="btn btn-outline-warning" href="{% url 'adjustment_create' %}">
          Ajuste (ADJ)
        </a>
        <a class="btn btn-outline-warning" href="{% url 'cycle_count' %}">
          Conteo cíclico
        </a>
      {% endif %}

      {% if can_export %}
        <a class="btn btn-outline-success" href="{% url 'reports_home' %}">
          Reportes
        </a>
      {% endif %}
    </div>

    <div class="text-muted small mt-2">
      Los accesos dependen del grupo del usuario (operator/supervisor/admin).
    </div>
  </div>
</div>

<!-- ===================== -->
<!-- Tablas recientes -->
<!-- ===================== -->
<div class="row g-3 mb-4">
  <div class="col-md-7">
    <div class="card shadow-sm">
      <div class="card-header">Movimientos recientes</div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-dark">
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th class="text-end">Qty</th>
                <th>SKU</th>
                <th>WH/Loc</th>
                <th>Usuario</th>
              </tr>
            </thead>
            <tbody>
              {% for m in recent_movements %}
              <tr>
                <td>{{ m.occurred_at }}</td>
                <td>{{ m.movement_type }}{% if m.is_void %} <span class="badge bg-warning text-dark">VOID</span>{% endif %}</td>
                <td class="text-end">{{ m.quantity }}</td>
                <td>{{ m.item.sku }}</td>
                <td>
                  {% if m.location %}
                    {{ m.location.warehouse.code }} / {{ m.location.code }}
                  {% else %}
                    <span class="text-muted">N/A</span>
                  {% endif %}
                </td>
                <td>{{ m.registered_by }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="6" class="text-muted p-3">Sin movimientos recientes.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <div class="col-md-5">
    <div class="card shadow-sm">
      <div class="card-header">Work Orders recientes</div>
      <div class="card-body p-0">
        {% if has_wo %}
        <div class="table-responsive">
          <table class="table table-sm mb-0 align-middle">
            <thead class="table-dark">
              <tr>
                <th>Código</th>
                <th>Status</th>
                <th>Asignado</th>
              </tr>
            </thead>
            <tbody>
              {% for wo in recent_wos %}
              <tr>
                <td><a href="{% url 'workorders:detail' wo.id %}">{{ wo.code }}</a></td>
                <td>{{ wo.status }}</td>
                <td>{{ wo.assigned_to|default:"-" }}</td>
              </tr>
              {% empty %}
              <tr><td colspan="3" class="text-muted p-3">Sin Work Orders.</td></tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        {% else %}
          <div class="p-3 text-muted">Work Orders no disponible.</div>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ===================== -->
<!-- Alertas con severidad -->
<!-- ===================== -->
<h4 class="mb-3">Alertas de stock bajo (por ubicación)</h4>

{% if low_stock %}
<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped table-bordered mb-0 align-middle">
        <thead class="table-dark">
          <tr>
            <th>SKU</th>
            <th>Artículo</th>
            <th>Almacén</th>
            <th>Ubicación</th>
            <th class="text-end">On Hand</th>
            <th class="text-end">Reserved</th>
            <th class="text-end">Available</th>
            <th class="text-end">Min</th>
          </tr>
        </thead>
        <tbody>
          {% for snap in low_stock %}

          {% if snap.severity == 3 %}
            <tr class="table-danger">
          {% elif snap.severity == 2 %}
            <tr class="table-warning">
          {% else %}
            <tr>
          {% endif %}

            <td>
              {{ snap.item.sku }}
              {% if snap.severity == 3 %}
                <span class="badge bg-danger ms-2">CRÍTICO</span>
              {% elif snap.severity == 2 %}
                <span class="badge bg-warning text-dark ms-2">ALTO</span>
              {% else %}
                <span class="badge bg-secondary ms-2">MEDIO</span>
              {% endif %}
            </td>

            <td>{{ snap.item.name }}</td>

            <td>
              {% if snap.location %}
                {{ snap.location.warehouse.code }}
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>

            <td>
              {% if snap.location %}
                {{ snap.location.code }}
              {% else %}
                <span class="text-muted">N/A</span>
              {% endif %}
            </td>

            <td class="text-end fw-semibold">{{ snap.on_hand }}</td>
            <td class="text-end">{{ snap.reserved0 }}</td>
            <td class="text-end fw-semibold">{{ snap.available }}</td>
            <td class="text-end">{{ snap.item.min_stock }}</td>

          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>
{% else %}
<div class="alert alert-success">
  No hay artículos con stock bajo.
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

{{ mv_labels|json_script:"mv-labels" }}
{{ mv_in|json_script:"mv-in" }}
{{ mv_out|json_script:"mv-out" }}
{{ mv_adj|json_script:"mv-adj" }}

{{ top_out_labels|json_script:"top-out-labels" }}
{{ top_out_values|json_script:"top-out-values" }}

{{ wh_labels|json_script:"wh-labels" }}
{{ wh_values|json_script:"wh-values" }}

<script>
  const mvLabels = JSON.parse(document.getElementById("mv-labels").textContent);
  const mvIn = JSON.parse(document.getElementById("mv-in").textContent);
  const mvOut = JSON.parse(document.getElementById("mv-out").textContent);
  const mvAdj = JSON.parse(document.getElementById("mv-adj").textContent);

  const topOutLabels = JSON.parse(document.getElementById("top-out-labels").textContent);
  const topOutValues = JSON.parse(document.getElementById("top-out-values").textContent);

  const whLabels = JSON.parse(document.getElementById("wh-labels").textContent);
  const whValues = JSON.parse(document.getElementById("wh-values").textContent);

  new Chart(document.getElementById("chartMovementsDaily"), {
    type: "line",
    data: {
      labels: mvLabels,
      datasets: [
        { label: "IN",  data: mvIn,  tension: 0.25 },
        { label: "OUT", data: mvOut, tension: 0.25 },
        { label: "ADJ", data: mvAdj, tension: 0.25 }
      ]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });

  new Chart(document.getElementById("chartTopOut"), {
    type: "bar",
    data: {
      labels: topOutLabels,
      datasets: [{ label: "Qty OUT", data: topOutValues }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });

  new Chart(document.getElementById("chartStockByWh"), {
    type: "bar",
    data: {
      labels: whLabels,
      datasets: [{ label: "On Hand", data: whValues }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } },
      scales: { y: { beginAtZero: true } }
    }
  });
</script>
{% endblock %}
