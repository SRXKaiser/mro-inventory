{% extends "base.html" %}
{% block title %}Reporte Stock{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0">Reporte: Stock por ubicación</h2>
  <a class="btn btn-outline-dark" href="{% url 'reports_home' %}">Volver</a>
</div>

<form method="get" class="card shadow-sm mb-3">
  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-3">
        <label class="form-label">Warehouse ID</label>
        <input class="form-control" name="warehouse_id" value="{{ filter_warehouse_id }}">
      </div>
      <div class="col-md-3">
        <label class="form-label">Location ID</label>
        <input class="form-control" name="location_id" value="{{ filter_location_id }}">
      </div>
      <div class="col-md-4">
        <label class="form-label">Buscar (SKU / Nombre)</label>
        <input class="form-control" name="q" value="{{ filter_q }}">
      </div>
      <div class="col-md-2 d-flex align-items-end">
        <div class="form-check">
          <input class="form-check-input" type="checkbox" name="low" value="1" id="id_low"
                 {% if filter_low == "1" %}checked{% endif %}>
          <label class="form-check-label" for="id_low">Solo bajo mínimo</label>
        </div>
      </div>
    </div>

    <hr class="my-3">

    <div class="d-flex gap-2">
      <button class="btn btn-primary" type="submit">Aplicar filtros</button>
      <a class="btn btn-outline-success"
         href="?warehouse_id={{ filter_warehouse_id }}&location_id={{ filter_location_id }}&q={{ filter_q }}&low={{ filter_low }}&download=1">
        Descargar CSV
      </a>
    </div>
  </div>
</form>

<div class="card shadow-sm">
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-sm mb-0 align-middle">
        <thead class="table-dark">
          <tr>
            <th>SKU</th>
            <th>Item</th>
            <th>WH</th>
            <th>Loc</th>
            <th class="text-end">On Hand</th>
            <th class="text-end">Reserved</th>
            <th class="text-end">Available</th>
            <th class="text-end">Min</th>
          </tr>
        </thead>
        <tbody>
          {% for s in snapshots %}
          <tr>
            <td>{{ s.item.sku }}</td>
            <td>{{ s.item.name }}</td>
            <td>{% if s.location %}{{ s.location.warehouse.code }}{% endif %}</td>
            <td>{% if s.location %}{{ s.location.code }}{% endif %}</td>
            <td class="text-end">{{ s.on_hand }}</td>
            <td class="text-end">{{ s.reserved }}</td>
            <td class="text-end">{{ s.available }}</td>
            <td class="text-end">{{ s.item.min_stock }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="8" class="text-muted p-3">Sin registros con esos filtros.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% if snapshots.paginator.num_pages > 1 %}
<nav class="mt-3">
  <ul class="pagination">
    {% if snapshots.has_previous %}
      <li class="page-item">
        <a class="page-link" href="?page={{ snapshots.previous_page_number }}&warehouse_id={{ filter_warehouse_id }}&location_id={{ filter_location_id }}&q={{ filter_q }}&low={{ filter_low }}">Anterior</a>
      </li>
    {% endif %}
    <li class="page-item disabled"><span class="page-link">Página {{ snapshots.number }} de {{ snapshots.paginator.num_pages }}</span></li>
    {% if snapshots.has_next %}
      <li class="page-item">
        <a class="page-link" href="?page={{ snapshots.next_page_number }}&warehouse_id={{ filter_warehouse_id }}&location_id={{ filter_location_id }}&q={{ filter_q }}&low={{ filter_low }}">Siguiente</a>
      </li>
    {% endif %}
  </ul>
</nav>
{% endif %}
{% endblock %}
